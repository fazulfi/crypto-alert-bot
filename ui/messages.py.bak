# ui/messages.py
from datetime import datetime, timezone, timedelta
try:
    from zoneinfo import ZoneInfo  # py3.9+
except Exception:
    ZoneInfo = None

def _fmt_price(p):
    """Format angka jadi 1,234.56; graceful if can't parse."""
    try:
        return f"{float(p):,.2f}"
    except Exception:
        return str(p)

def _to_wib(dt=None):
    """Convert datetime (aware or naive UTC) -> Asia/Jakarta timezone.
       If zoneinfo not available, fallback +7h."""
    if dt is None:
        dt = datetime.now(timezone.utc)
    # accept ISO string
    if isinstance(dt, str):
        try:
            dt = datetime.fromisoformat(dt)
        except Exception:
            dt = datetime.now(timezone.utc)
    # if naive, assume UTC
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
    try:
        if ZoneInfo:
            return dt.astimezone(ZoneInfo("Asia/Jakarta"))
        else:
            return dt + timedelta(hours=7)
    except Exception:
        return dt + timedelta(hours=7)

# ---------------------- message templates ----------------------

def START_TEXT():
    return (
        "<b>Crypto Alert Bot</b>\n"
        "<i>Perintah:</i>\n"
        "/price SYMBOL\n"
        "/setalert SYMBOL above|below PRICE\n"
        "/alerts\n"
        "/remove ID\n\n"
        "<i>Kirim 1 perintah per pesan.</i>"
    )

def PRICE_TEMPLATE(symbol, price):
    """Jika price None -> error message."""
    if price is None:
        return f"Gagal ambil harga untuk <b>{symbol}</b>"
    return f"<b>{symbol}</b> price: <code>{_fmt_price(price)}</code>"

def ALERT_SET(symbol, direction, price, aid=None):
    s = f"âœ… <b>Alert diset:</b> <b>{symbol}</b> {direction} {_fmt_price(price)}"
    if aid is not None:
        s += f" <i>(id={aid})</i>"
    return s

def ALERT_TEMPLATE(symbol, direction, threshold, current, ts=None):
    wib = _to_wib(ts)
    time_str = wib.strftime("%Y-%m-%d %H:%M:%S")
    return (
        "ðŸš¨ <b>ALERT</b>\n"
        f"<b>{symbol}</b> sudah <i>{direction}</i> {_fmt_price(threshold)}\n\n"
        f"<b>Current:</b> <code>{_fmt_price(current)}</code>\n"
        f"<b>Waktu:</b> {time_str} WIB"
    )

def no_alerts_message():
    return "Kamu tidak punya alert."

def usage_price():
    return "Usage: /price SYMBOL"

def usage_setalert():
    return "Usage: /setalert SYMBOL above|below PRICE"


# --- backward compatibility aliases (string values, not callables) ---
def _str(val):
    try:
        return val() if callable(val) else val
    except Exception:
        # jika pemanggilan fungsi error, kembalikan string kosong daripada fungsi
        return ''

# map old uppercase names to current variables (update list kalau perlu)
try:
    START_TEXT = _str(start_message)
except NameError:
    START_TEXT = ''

try:
    PRICE_TEMPLATE = _str(price_message)
except NameError:
    PRICE_TEMPLATE = ''

try:
    ALERT_TEMPLATE = _str(alert_trigger_message)
except NameError:
    ALERT_TEMPLATE = ''

# also create a few usage aliases if handlers expect them
try:
    USAGE_SETA = _str(usage_setalert)
except NameError:
    pass

# end compatibility block
